<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èŠå¤©å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ (è®“ç•«é¢æ›´ä¹¾æ·¨) */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        
        /* æ‰“å­—æ©Ÿæ¸¸æ¨™å‹•ç•« */
        .typing-cursor::after {
            content: 'â–‹';
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* éš±è—å€å¡Šé€šç”¨é¡åˆ¥ */
        .hidden-section { display: none !important; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col items-center justify-center font-sans">

    <div id="loginSection" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">æ­¡è¿å›ä¾†</h2>
                <p class="text-gray-500 text-sm mt-2">è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
            </div>
            
            <input type="password" id="passwordInput" 
                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all bg-gray-50 mb-4"
                placeholder="è¼¸å…¥å¯†ç¢¼..."
                onkeypress="if(event.key === 'Enter') doLogin()"
            >
            <button onclick="doLogin()" id="loginBtn"
                class="w-full bg-blue-600 hover:bg-blue-700 active:scale-95 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-blue-600/30">
                ç™»å…¥ç³»çµ±
            </button>
            <p id="loginError" class="text-red-500 text-center text-sm mt-4 hidden-section"></p>
        </div>
    </div>

    <div id="chatSection" class="w-full max-w-3xl h-full md:h-[90vh] bg-white md:rounded-2xl shadow-xl flex flex-col overflow-hidden hidden-section relative">
        
        <header class="bg-white border-b border-gray-100 p-4 flex justify-between items-center z-10 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-md">
                    AI
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 text-lg leading-tight">æ™ºæ…§åŠ©æ‰‹</h1>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-xs text-gray-500 font-medium">ç·šä¸Š</span>
                    </div>
                </div>
            </div>
            <button onclick="doLogout()" class="text-sm text-gray-400 hover:text-red-500 transition px-3 py-1 hover:bg-red-50 rounded-lg">
                ç™»å‡º
            </button>
        </header>

        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-6 bg-gray-50">
            <div class="flex justify-start">
                <div class="flex items-end gap-2 max-w-[85%]">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm">AI</div>
                    <div class="bg-white p-3.5 rounded-2xl rounded-bl-none shadow-sm text-gray-700 leading-relaxed border border-gray-100">
                        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹ã€‚ä»Šå¤©æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ ğŸ˜Š
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-gray-100">
            <div class="flex items-end gap-2 bg-gray-50 p-2 rounded-xl border border-gray-200 focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500 transition-all">
                <textarea id="questionInput" rows="1"
                    class="w-full bg-transparent border-none focus:ring-0 p-2 resize-none max-h-32 text-gray-700 placeholder-gray-400"
                    placeholder="è¼¸å…¥è¨Šæ¯..."
                    oninput="autoResize(this)"
                    onkeydown="handleEnter(event)"
                ></textarea>
                <button onclick="sendMessage()" id="sendBtn"
                    class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:scale-90 transition-all shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
            <p class="text-center text-xs text-gray-400 mt-2">AI å¯èƒ½æœƒç”¢ç”ŸéŒ¯èª¤è³‡è¨Šï¼Œè«‹æ ¸å¯¦é‡è¦å…§å®¹ã€‚</p>
        </div>
    </div>

    <script>
        // --- ç‹€æ…‹ç®¡ç† ---
        let savedToken = localStorage.getItem('chat_token');
        const messagesContainer = document.getElementById('messagesContainer');
        const questionInput = document.getElementById('questionInput');
        const sendBtn = document.getElementById('sendBtn');

        // åˆå§‹åŒ–æª¢æŸ¥
        if (savedToken) {
            showChatUI();
        }

        // --- ç™»å…¥é‚è¼¯ ---
        async function doLogin() {
            const pwd = document.getElementById('passwordInput').value;
            const btn = document.getElementById('loginBtn');
            const err = document.getElementById('loginError');

            if (!pwd) return;
            
            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸­...";
            err.classList.add('hidden-section');

            try {
                // å‘¼å«å¾Œç«¯ /login
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: pwd })
                });

                if (res.ok) {
                    const data = await res.json();
                    savedToken = data.token;
                    localStorage.setItem('chat_token', savedToken);
                    showChatUI();
                } else {
                    err.innerText = "å¯†ç¢¼éŒ¯èª¤";
                    err.classList.remove('hidden-section');
                }
            } catch (e) {
                err.innerText = "ä¼ºæœå™¨é€£ç·šå¤±æ•—";
                err.classList.remove('hidden-section');
            } finally {
                btn.disabled = false;
                btn.innerText = "ç™»å…¥ç³»çµ±";
            }
        }

        function doLogout() {
            localStorage.removeItem('chat_token');
            location.reload();
        }

        function showChatUI() {
            document.getElementById('loginSection').classList.add('hidden-section');
            document.getElementById('chatSection').classList.remove('hidden-section');
            // èšç„¦è¼¸å…¥æ¡†
            setTimeout(() => questionInput.focus(), 100);
        }

        // --- èŠå¤©æ ¸å¿ƒé‚è¼¯ ---
        
        // è‡ªå‹•èª¿æ•´ Textarea é«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 128) + 'px';
        }

        // æŒ‰ Enter ç™¼é€ (Shift+Enter æ›è¡Œ)
        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // æ¸²æŸ“è¨Šæ¯æ°£æ³¡
        function appendMessage(role, text) {
            const isUser = role === 'user';
            const alignClass = isUser ? 'justify-end' : 'justify-start';
            const bubbleColor = isUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-700 border border-gray-100 rounded-bl-none';
            const avatar = isUser ? '' : `<div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-600 flex-shrink-0 flex items-center justify-center text-white text-xs shadow-sm">AI</div>`;
            
            const html = `
                <div class="flex ${alignClass} animate-fade-in-up">
                    <div class="flex items-end gap-2 max-w-[85%]">
                        ${avatar}
                        <div class="p-3.5 rounded-2xl shadow-sm leading-relaxed whitespace-pre-wrap ${bubbleColor}">${text}</div>
                    </div>
                </div>
            `;
            
            // æ’å…¥ HTML
            messagesContainer.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        // é¡¯ç¤º/ç§»é™¤ Loading å‹•ç•«
        let loadingElement = null;
        function showLoading() {
            const html = `
                <div id="loadingBubble" class="flex justify-start">
                    <div class="flex items-end gap-2">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-indigo-600 flex-shrink-0 flex items-center justify-center text-white text-xs">AI</div>
                        <div class="bg-white p-4 rounded-2xl rounded-bl-none shadow-sm border border-gray-100">
                            <div class="flex space-x-1">
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', html);
            loadingElement = document.getElementById('loadingBubble');
            scrollToBottom();
        }

        function removeLoading() {
            if (loadingElement) loadingElement.remove();
        }

        function scrollToBottom() {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        // ç™¼é€è¨Šæ¯ä¸»ç¨‹å¼
        async function sendMessage() {
            const text = questionInput.value.trim();
            if (!text) return;

            // 1. æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é‡ç½®é«˜åº¦
            questionInput.value = '';
            questionInput.style.height = 'auto';
            
            // 2. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            appendMessage('user', text);

            // 3. é–å®šæŒ‰éˆ•ä¸¦é¡¯ç¤º Loading
            sendBtn.disabled = true;
            showLoading();

            try {
                // 4. å‘¼å«å¾Œç«¯ API
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-secret-token': savedToken // å¸¶ä¸Š Token
                    },
                    body: JSON.stringify({ user: text })
                });

                removeLoading();

                if (res.status === 401) {
                    appendMessage('ai', 'âš ï¸ èªè­‰å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚');
                    setTimeout(doLogout, 2000);
                    return;
                }

                if (!res.ok) throw new Error('API Error');

                const data = await res.json();
                
                // 5. é¡¯ç¤º AI å›ç­”
                appendMessage('ai', data.answer);

            } catch (error) {
                removeLoading();
                appendMessage('ai', 'âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                console.error(error);
            } finally {
                sendBtn.disabled = false;
                // é‡æ–°èšç„¦è¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿é€£çºŒå°è©±
                questionInput.focus();
            }
        }
    </script>
</body>
</html>